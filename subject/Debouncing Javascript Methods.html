<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端学习笔记 | Debouncing Javascript Methodshttp://unscriptable.com/author/john-hann/)</title>
    <meta name="description" content="前端学习笔记">
    
    
    <link rel="preload" href="/notebook/assets/css/24.styles.54e121d1.css" as="style"><link rel="preload" href="/notebook/assets/js/app.e422ee42.js" as="script"><link rel="preload" href="/notebook/assets/js/16.e904e7c8.js" as="script"><link rel="prefetch" href="/notebook/assets/js/13.4a676149.js"><link rel="prefetch" href="/notebook/assets/js/1.0504529f.js"><link rel="prefetch" href="/notebook/assets/js/2.ff25ac17.js"><link rel="prefetch" href="/notebook/assets/js/3.3214ee55.js"><link rel="prefetch" href="/notebook/assets/js/4.91ed248e.js"><link rel="prefetch" href="/notebook/assets/js/5.f6d88800.js"><link rel="prefetch" href="/notebook/assets/js/6.196e425a.js"><link rel="prefetch" href="/notebook/assets/js/7.751555b3.js"><link rel="prefetch" href="/notebook/assets/js/8.f9163292.js"><link rel="prefetch" href="/notebook/assets/js/9.f8f2301a.js"><link rel="prefetch" href="/notebook/assets/js/10.daa165f6.js"><link rel="prefetch" href="/notebook/assets/js/11.6739d9ca.js"><link rel="prefetch" href="/notebook/assets/js/12.6a663263.js"><link rel="prefetch" href="/notebook/assets/js/0.af20d5dc.js"><link rel="prefetch" href="/notebook/assets/js/14.5b9129c1.js"><link rel="prefetch" href="/notebook/assets/js/15.578148e5.js"><link rel="prefetch" href="/notebook/assets/js/17.51e48bca.js"><link rel="prefetch" href="/notebook/assets/js/18.b86da157.js"><link rel="prefetch" href="/notebook/assets/js/19.4d1f3647.js"><link rel="prefetch" href="/notebook/assets/js/20.db4d947d.js"><link rel="prefetch" href="/notebook/assets/js/21.c8cf075f.js"><link rel="prefetch" href="/notebook/assets/js/22.d56c9864.js"><link rel="prefetch" href="/notebook/assets/js/23.ef174104.js">
    <link rel="stylesheet" href="/notebook/assets/css/24.styles.54e121d1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/notebook/" class="home-link router-link-active"><!----><span class="site-name">
      前端学习笔记
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/tutorial/" class="nav-link">教程笔记</a></div><div class="nav-item"><a href="/notebook/subject/" class="nav-link router-link-active">专题</a></div><div class="nav-item"><a href="/notebook/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/notebook/question/" class="nav-link">题</a></div><div class="nav-item"><a href="/notebook/algorithm/" class="nav-link">算法</a></div><a href="https://github.com/athena0304/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/tutorial/" class="nav-link">教程笔记</a></div><div class="nav-item"><a href="/notebook/subject/" class="nav-link router-link-active">专题</a></div><div class="nav-item"><a href="/notebook/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/notebook/question/" class="nav-link">题</a></div><div class="nav-item"><a href="/notebook/algorithm/" class="nav-link">算法</a></div><a href="https://github.com/athena0304/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/notebook/subject/" class="sidebar-link">专题</a></li><li><a href="/notebook/subject/throttle-debouce.html" class="sidebar-link">throttle和debounce</a></li><li><a href="/notebook/subject/examples.html" class="sidebar-link">【译】通过例子解释 Debounce 和 Throttle</a></li></ul></div><div class="page"><div class="content"><h1 id="debouncing-javascript-methodshttp-unscriptable-com-author-john-hann"><a href="#debouncing-javascript-methodshttp-unscriptable-com-author-john-hann" aria-hidden="true" class="header-anchor">#</a> Debouncing Javascript Methodshttp://unscriptable.com/author/john-hann/)</h1><p>http://unscriptable.com/2009/03/20/debouncing-javascript-methods/</p><p>Back in 2006, I was the lead front-end architect for a mission-critical Web 2.0 application. Yah-yah, aren’t they all mission-critical? Yes, but this one really was critical since it was one of those make-or-break moments for the product. What made this project really interesting were the unrealistic expectations the product managers had of web apps.</p><p>Sometimes, pressure like this can lead to creativity and innovation. On this occasion, it helped me reach back in to my electrical engineering coursework to apply a hardware concept to software programming.
Just imagine this:</p><ol><li>You are tasked to write the entire Javascript-based framework from scratch, including the core functions (inheritance, declarations, event connections), DOM manipulation and querying, a widget framework, MVC, drag-and-drop, and dozens of custom widgets to boot.</li><li>You are given unintuitive and un-web-like requirements to ensure that the app allowed customers to adhere to strict FDA regulations.</li><li>The product managers had no experience with web app development so they designed the requirements for a Windows application. You know: modal dialogs, instant retrieval of large amounts of data (as if it were coming straight from the disk), workflows that depended on sequenced calls to/from the back-end systems, etc.</li></ol><p>Oh, and did I mention there was a deadline and only two of us were hired to code the entire UI side of the project?</p><p>Well, I am always up for a challenge, especially if somebody says, “It can’t be done”. So needless to say, I had to really use my brain on this project.</p><p>One of the more interesting requirements was to show the user a summary side-bar of information pertaining to the current field (i.e. the input element that had focus). This side-bar information could be from several kilobytes to more than 100 kB. The data had to be fetched via XHR from the back-end and displayed each time the user entered a new field.</p><p>This presented a major problem if the user was keyboard-oriented and preferred to use the Tab key to move from field to field. There could be hundreds of fields on the screen, and a user could simply lean on the Tab key to navigate from one end of the form to the other. If the user were lucky enough to be on a fast network connection and had a fast enough browser, this would go fairly smoothly. However, the server would get absolutely hammered by all of the XHR requests necessary to populate the side-bar!</p><p>Luckily, I had handled this situation several times before. A simple setTimeout and a few state variables fixes this problem fairly easily. But there were several of these situations in this project, and I wanted to build something reusable.</p><p>The more I thought about it, the more it felt like <a href="http://en.wikipedia.org/wiki/Switch#Contact_bounce" target="_blank" rel="noopener noreferrer">contact debouncing<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>. Debouncing means to coalesce several temporally close signals into one signal. For example, your computer keyboard does this. Every time you hit a key, the contacts actually bounce a few times, causing several signals to be sent to the circuitry. The circuitry determines that the bouncing has ended when no bounces are detected within a certain period (the “detection period”). Since people can’t really type faster than roughly 10 keys per second, any signals happening within 100 msec of each other, for example, are likely part of the same key press. (In practice, you should at least halve this, so about 50 msec for our keyboard example. I have no idea what keyboards really use, by the way. This is just an illustration.)</p><h2 id="debouncing-throttling"><a href="#debouncing-throttling" aria-hidden="true" class="header-anchor">#</a> Debouncing != Throttling</h2><p>Whenever I bring up the concept of debouncing, developers try to cast it as just a means of throttling. But that’s not true at all. Throttling is the reduction in rate of a repeating event. Throttling is good for reducing mousemove events to a lesser, manageable rate, for instance.</p><p>Debouncing is quite more precise. Debouncing ensures that exactly one signal is sent for an event that may be happening several times — or even several hundreds of times over an extended period. As long as the events are occurring fast enough to happen at least once in every detection period, the signal will not be sent!</p><p>Let’s relate this back to our keyboard-oriented user and our huge set of form fields. Throttling here would certainly help. We could reduce the number of XHR requests to a lower rate than the computer’s key repeat rate for sure! However, we’d still be fetching from the back-end more times than necessary, and the occasional re-rendering of the fetched data could temporarily freeze up the browser, deteriorating the user experience.</p><p>Debouncing on the other hand could better detect when the user stopped leaning on the keyboard and had arrived at their destination. It’s certainly not perfect. The user still may overshoot their destination, hesitate, and back-track, causing enough delay for the debounce detection period to expire. However, our tests showed that debouncing did a much better job of reducing XHR requests than throttling.</p><h2 id="implementation"><a href="#implementation" aria-hidden="true" class="header-anchor">#</a> Implementation</h2><p>The original debounce method was rather large and clunky. I consider it a prototype. A proof of concept. I ended up needing debouncing a few times since that project and rewrote it each time, trying to improve it. I’ve finally devised something that feels good enough to share.</p><p>The latest rendition takes two parameters: the detection period (“threshold”) and a Boolean indicating whether the signal should happen at the beginning of the detection period (true) or the end (“execAsap”).</p><p>Here it is:</p><div class="language-js extra-class"><pre class="language-js"><code>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>threshold<span class="token punctuation">,</span> execAsap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> func <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">// reference to original function</span>
        timeout<span class="token punctuation">;</span> <span class="token comment">// handle to setTimeout async task (detection period)</span>
    <span class="token comment">// return the new debounced function which executes the original function only once</span>
    <span class="token comment">// until the detection period expires</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">debounced</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token comment">// reference to original context object</span>
            args <span class="token operator">=</span> arguments<span class="token punctuation">;</span> <span class="token comment">// arguments at execution time</span>
        <span class="token comment">// this is the detection function. it will be executed if/when the threshold expires</span>
        <span class="token keyword">function</span> <span class="token function">delayed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// if we're executing at the end of the detection period</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>execAsap<span class="token punctuation">)</span>
                func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// execute now</span>
            <span class="token comment">// clear timeout handle</span>
            timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// stop any current detection period</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// otherwise, if we're not already waiting and we're executing at the beginning of the detection period</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>execAsap<span class="token punctuation">)</span>
            func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// execute now</span>
        <span class="token comment">// reset the detection period</span>
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>delayed<span class="token punctuation">,</span> threshold <span class="token operator">||</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>It works by issuing a setTimeout at the specified detection period. Each time the function is called, the setTimeout is canceled and issued again. This serves as our detection mechanism, but using reverse logic. If/when the setTimeout executes, we know that our function was not called within the detection period.</p><p>Wow. It looks rather large with all of those comments. Here is a version without the comments:</p><div class="language-js extra-class"><pre class="language-js"><code>Function<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">debounce</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>threshold<span class="token punctuation">,</span> execAsap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 
    <span class="token keyword">var</span> func <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> timeout<span class="token punctuation">;</span>
 
    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">debounced</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
        <span class="token keyword">function</span> <span class="token function">delayed</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>execAsap<span class="token punctuation">)</span>
                func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            timeout <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span>
            <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>execAsap<span class="token punctuation">)</span>
            func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
        timeout <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>delayed<span class="token punctuation">,</span> threshold <span class="token operator">||</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
</code></pre></div><p>If you prefer not to augment the native objects, here’s a stand-alone version:</p><div class="language- extra-class"><pre class="language-text"><code>var debounce = function (func, threshold, execAsap) {
 
    var timeout;
 
    return function debounced () {
        var obj = this, args = arguments;
        function delayed () {
            if (!execAsap)
                func.apply(obj, args);
            timeout = null; 
        };
 
        if (timeout)
            clearTimeout(timeout);
        else if (execAsap)
            func.apply(obj, args);
 
        timeout = setTimeout(delayed, threshold || 100); 
    };
 
}

</code></pre></div><p>Example uses:</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// using debounce in a constructor or initialization function to debounce </span>
<span class="token comment">// focus events for a widget (onFocus is the original handler):</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>debouncedOnFocus <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>onFocus<span class="token punctuation">.</span><span class="token function">debounce</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>inputNode<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'focus'</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>debouncedOnFocus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
<span class="token comment">// to coordinate the debounce of a method for all objects of a certain class, do this:</span>
MyClass<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">someMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* do something here, but only once */</span>
<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">debounce</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// execute at start and use a 100 msec detection period</span>
 
 
<span class="token comment">// the dojo way to coordinate the debounce of a method for all objects of a certain class</span>
<span class="token comment">// (using the stand-alone version)</span>
dojo<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token string">'MyClass'</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
 
    <span class="token comment">// other members go here</span>
 
    someMethod<span class="token punctuation">:</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">/* do something here, but only once */</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// execute at start and use a 100 msec detection period</span>
 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 
<span class="token comment">// wait until the user is done moving the mouse, then execute</span>
<span class="token comment">// (using the stand-alone version)</span>
document<span class="token punctuation">.</span>onmousemove <span class="token operator">=</span> <span class="token function">debounce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/* do something here, but only once after mouse cursor stops */</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>Let me know if you find this useful in your projects!</strong></p><p>P.S. The mission-critical project was a success!</p></div><!----><!----></div></div></div>
    <script src="/notebook/assets/js/16.e904e7c8.js" defer></script><script src="/notebook/assets/js/app.e422ee42.js" defer></script>
  </body>
</html>

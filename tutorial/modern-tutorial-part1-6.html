<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>前端学习笔记 | 高级函数</title>
    <meta name="description" content="前端学习笔记">
    
    
    <link rel="preload" href="/notebook/assets/css/24.styles.54e121d1.css" as="style"><link rel="preload" href="/notebook/assets/js/app.e422ee42.js" as="script"><link rel="preload" href="/notebook/assets/js/4.91ed248e.js" as="script"><link rel="prefetch" href="/notebook/assets/js/13.4a676149.js"><link rel="prefetch" href="/notebook/assets/js/1.0504529f.js"><link rel="prefetch" href="/notebook/assets/js/2.ff25ac17.js"><link rel="prefetch" href="/notebook/assets/js/3.3214ee55.js"><link rel="prefetch" href="/notebook/assets/js/5.f6d88800.js"><link rel="prefetch" href="/notebook/assets/js/6.196e425a.js"><link rel="prefetch" href="/notebook/assets/js/7.751555b3.js"><link rel="prefetch" href="/notebook/assets/js/8.f9163292.js"><link rel="prefetch" href="/notebook/assets/js/9.f8f2301a.js"><link rel="prefetch" href="/notebook/assets/js/10.daa165f6.js"><link rel="prefetch" href="/notebook/assets/js/11.6739d9ca.js"><link rel="prefetch" href="/notebook/assets/js/12.6a663263.js"><link rel="prefetch" href="/notebook/assets/js/0.af20d5dc.js"><link rel="prefetch" href="/notebook/assets/js/14.5b9129c1.js"><link rel="prefetch" href="/notebook/assets/js/15.578148e5.js"><link rel="prefetch" href="/notebook/assets/js/16.e904e7c8.js"><link rel="prefetch" href="/notebook/assets/js/17.51e48bca.js"><link rel="prefetch" href="/notebook/assets/js/18.b86da157.js"><link rel="prefetch" href="/notebook/assets/js/19.4d1f3647.js"><link rel="prefetch" href="/notebook/assets/js/20.db4d947d.js"><link rel="prefetch" href="/notebook/assets/js/21.c8cf075f.js"><link rel="prefetch" href="/notebook/assets/js/22.d56c9864.js"><link rel="prefetch" href="/notebook/assets/js/23.ef174104.js">
    <link rel="stylesheet" href="/notebook/assets/css/24.styles.54e121d1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/notebook/" class="home-link router-link-active"><!----><span class="site-name">
      前端学习笔记
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/notebook/tutorial/" class="nav-link router-link-active">教程笔记</a></div><div class="nav-item"><a href="/notebook/subject/" class="nav-link">专题</a></div><div class="nav-item"><a href="/notebook/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/notebook/question/" class="nav-link">题</a></div><div class="nav-item"><a href="/notebook/algorithm/" class="nav-link">算法</a></div><a href="https://github.com/athena0304/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notebook/tutorial/" class="nav-link router-link-active">教程笔记</a></div><div class="nav-item"><a href="/notebook/subject/" class="nav-link">专题</a></div><div class="nav-item"><a href="/notebook/basic/" class="nav-link">基础</a></div><div class="nav-item"><a href="/notebook/question/" class="nav-link">题</a></div><div class="nav-item"><a href="/notebook/algorithm/" class="nav-link">算法</a></div><a href="https://github.com/athena0304/notebook" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav><ul class="sidebar-links"><li><a href="/notebook/tutorial/" class="sidebar-link">翻译术语</a></li><li><a href="/notebook/tutorial/modern-tutorial-part1.html" class="sidebar-link">PART 1</a></li><li><a href="/notebook/tutorial/modern-tutorial-part1-6.html" class="active sidebar-link">高级函数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-1-recursion-and-stack-递归和栈" class="sidebar-link">6.1 Recursion and stack-递归和栈</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-2-rest-parameters-and-spread-operator-剩余参数与展开运算符" class="sidebar-link">6.2 Rest parameters and spread operator-剩余参数与展开运算符</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-3-闭包" class="sidebar-link">6.3 闭包</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-4-the-old-var" class="sidebar-link">6.4 The old &quot;var&quot;</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-5-global-object-全局对象" class="sidebar-link">6.5 Global object-全局对象</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-6-function-object-nfe" class="sidebar-link">6.6 Function object, NFE</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-7-the-new-function-syntax" class="sidebar-link">6.7 The &quot;new Function&quot; syntax</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-8-scheduling-settimeout-and-setinterval" class="sidebar-link">6.8 Scheduling: setTimeout and setInterval</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-9-decorators-and-forwarding-call-apply" class="sidebar-link">6.9 Decorators and forwarding, call/apply</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-10-function-binding" class="sidebar-link">6.10 Function binding</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-11-currying-and-partials" class="sidebar-link">6.11 Currying and partials</a></li><li class="sidebar-sub-header"><a href="/notebook/tutorial/modern-tutorial-part1-6.html#_6-12-arrow-functions-revisited" class="sidebar-link">6.12 Arrow functions revisited</a></li></ul></li><li><a href="/notebook/tutorial/modern-tutorial-part2.html" class="sidebar-link">PART 2</a></li><li><a href="/notebook/tutorial/modern-tutorial-part3.html" class="sidebar-link">PART 3</a></li></ul></div><div class="page"><div class="content"><h1 id="高级函数"><a href="#高级函数" aria-hidden="true" class="header-anchor">#</a> 高级函数</h1><h2 id="_6-1-recursion-and-stack-递归和栈"><a href="#_6-1-recursion-and-stack-递归和栈" aria-hidden="true" class="header-anchor">#</a> 6.1 Recursion and stack-递归和栈</h2><p>Iterative：迭代</p><p>Recursive： 递归</p><p>execution context.：执行上下文</p><p>execution context stack：执行上下文栈</p><p>一个函数运行的信息被存储在它的<strong>执行上下文</strong>中。</p><p>The execution context is an internal data structure that contains details about the execution of a function: where the control flow is now, the current variables, the value of this (we don’t use it here) and few other internal details.</p><p>执行上下文是一种内部的数据结构，包含了函数执行的细节：控制流的位置、当前的变量、this的值和一些少量的其它内部细节。</p><p>Context: { x: 2, n: 3, at line 5 } pow(2, 3)</p><p>Any recursion can be rewritten as a loop.</p><p>任何递归都可以用循环来重写。</p><h3 id="递归遍历"><a href="#递归遍历" aria-hidden="true" class="header-anchor">#</a> 递归遍历</h3><p>求公司所有人的工资总和</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> company <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">// the same object, compressed for brevity</span>
  sales<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'John'</span><span class="token punctuation">,</span> salary<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Alice'</span><span class="token punctuation">,</span> salary<span class="token punctuation">:</span> <span class="token number">600</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  development<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    sites<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Peter'</span><span class="token punctuation">,</span> salary<span class="token punctuation">:</span> <span class="token number">2000</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Alex'</span><span class="token punctuation">,</span> salary<span class="token punctuation">:</span> <span class="token number">1800</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    internals<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">'Jack'</span><span class="token punctuation">,</span> salary<span class="token punctuation">:</span> <span class="token number">1300</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// The function to do the job</span>
<span class="token keyword">function</span> <span class="token function">sumSalaries</span><span class="token punctuation">(</span>department<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>department<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// case (1)</span>
    <span class="token keyword">return</span> department<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>prev<span class="token punctuation">,</span> current<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> prev <span class="token operator">+</span> current<span class="token punctuation">.</span>salary<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// sum the array</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// case (2)</span>
    <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> subdep <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span>department<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      sum <span class="token operator">+=</span> <span class="token function">sumSalaries</span><span class="token punctuation">(</span>subdep<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// recursively call for subdepartments, sum the results</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">alert</span><span class="token punctuation">(</span><span class="token function">sumSalaries</span><span class="token punctuation">(</span>company<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6700</span>
</code></pre></div><h2 id="_6-2-rest-parameters-and-spread-operator-剩余参数与展开运算符"><a href="#_6-2-rest-parameters-and-spread-operator-剩余参数与展开运算符" aria-hidden="true" class="header-anchor">#</a> 6.2 Rest parameters and spread operator-剩余参数与展开运算符</h2><h3 id="参数的两种形式："><a href="#参数的两种形式：" aria-hidden="true" class="header-anchor">#</a> 参数的两种形式：</h3><ul><li>若 <code>...</code> 出现在函数的参数列表，那它表示的就是 Rest 参数，它会把函数多余的实参收集到一个数组中。</li><li>若 <code>...</code> 出现在函数调用或类似的表达式中，那它就是 Spread 操作符，它会把一个数组展开为逗号分隔的元素列表。</li></ul><h4 id="剩余参数"><a href="#剩余参数" aria-hidden="true" class="header-anchor">#</a> 剩余参数</h4><p>剩余参数用 <code>...args</code> 表示，意思就是把剩余的参数放在数组 <code>args</code> 中</p><p>例如将所有参数加和：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">sumAll</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 数组变量名为 args</span>
  <span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> arg <span class="token keyword">of</span> args<span class="token punctuation">)</span> sum <span class="token operator">+=</span> arg<span class="token punctuation">;</span>

  <span class="token keyword">return</span> sum<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sumAll</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sumAll</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sumAll</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>
</code></pre></div><p>也可以前面定义一些参数，然后再把剩下的参数收集起来。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">showName</span><span class="token punctuation">(</span>firstName<span class="token punctuation">,</span> lastName<span class="token punctuation">,</span> <span class="token operator">...</span>titles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> firstName <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> lastName <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Julius Caesar</span>

  <span class="token comment">// titles 数组中包含了剩余的参数</span>
  <span class="token comment">// 也就是有 titles = [&quot;Consul&quot;, &quot;Imperator&quot;]</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> titles<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Consul</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> titles<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Imperator</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> titles<span class="token punctuation">.</span>length <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token punctuation">}</span>

<span class="token function">showName</span><span class="token punctuation">(</span><span class="token string">&quot;Julius&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Caesar&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Consul&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Imperator&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="arguments-变量"><a href="#arguments-变量" aria-hidden="true" class="header-anchor">#</a> &quot;arguments&quot; 变量</h4><p>arguments是类数组，可遍历，但是没有数组原型链上的函数，所以不能直接调用一些数组方法。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">showName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> arguments<span class="token punctuation">.</span>length <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> arguments<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 它是可遍历的</span>
  <span class="token comment">// for(let arg of arguments) alert(arg);</span>
<span class="token punctuation">}</span>

<span class="token comment">// 依次弹出提示：2，Julius，Caesar</span>
<span class="token function">showName</span><span class="token punctuation">(</span><span class="token string">&quot;Julius&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Caesar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 依次弹出提示：1，Ilya，undefined（不存在第二个参数）</span>
<span class="token function">showName</span><span class="token punctuation">(</span><span class="token string">&quot;Ilya&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>另外，箭头函数没有 arguments，而是属于外部普通的函数：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token function-variable function">showArg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span>arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">showArg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div><p>箭头函数没有this，也没有arguments</p><h3 id="扩展运算符"><a href="#扩展运算符" aria-hidden="true" class="header-anchor">#</a> 扩展运算符</h3><p>扩展运算符与剩余参数相反的过程，一个是函数的参数，一个是函数调用的时候使用</p><p>一个是把参数收集为数组，一个是把数组展开为参数列表。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token operator">...</span>arr<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 5（Spread 操作符把数组转为参数列表）</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> arr2 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">*</span><span class="token operator">!</span><span class="token operator">*</span>
<span class="token keyword">let</span> merged <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">...</span>arr<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">...</span>arr2<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">*</span><span class="token operator">/</span><span class="token operator">!</span><span class="token operator">*</span>

<span class="token function">alert</span><span class="token punctuation">(</span>merged<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0,3,5,1,2,8,9,15（0，然后是 arr 的值，2，然后是 arr2 的值）</span>
</code></pre></div><p>还可以展开字符串</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token operator">...</span>str<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// H,e,l,l,o</span>
</code></pre></div><p>也可以用 <code>Array.from</code> 来实现：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> str <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// Array.from 会将可遍历对象转为数组</span>
<span class="token function">alert</span><span class="token punctuation">(</span> Array<span class="token punctuation">.</span><span class="token keyword">from</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// H,e,l,l,o</span>
</code></pre></div><ul><li><code>Array.from</code> 同时适用于类数组对象和可遍历对象。</li><li>Spread 操作符只能操作可遍历对象。</li></ul><h2 id="_6-3-闭包"><a href="#_6-3-闭包" aria-hidden="true" class="header-anchor">#</a> 6.3 闭包</h2><h3 id="词法环境"><a href="#词法环境" aria-hidden="true" class="header-anchor">#</a> 词法环境</h3><p>在 JavaScript 中，每个运行的函数、代码块或整个程序，都有一个称为**词法环境（Lexical Environment）**的关联对象。</p><p>词法环境（Lexical Environment）分为两部分：</p><ul><li><ol><li><em>Environment Record</em> – an object that has all local variables as its properties (and some other information like the value of <code>this</code>).</li><li>A reference to the <em>outer lexical environment</em>, usually the one associated with the code lexically right outside of it (outside of the current curly brackets).</li></ol></li></ul><ol><li>环境记录——是一个对象，所有本地变量作为其属性（还有一些其它信息，比如 <code>this</code> 的值）</li><li>对外部词法环境的引用，通常与它外部（当前花括号外部）的代码在词法上相关联。</li></ol><p>全局词法环境（global Lexical Environment）没有外部引用，指向 <code>null</code></p><p><img src="https://javascript.info/article/closure/lexical-environment-global.png" alt="img"></p><p><img src="https://javascript.info/article/closure/lexical-environment-global-2.png" alt="img"></p><ul><li>变量是特定内部对象的属性，与当前执行的（代码）块/函数/脚本有关。</li><li>操作变量实际上操作的是该对象的属性。</li></ul><h4 id="函数声明"><a href="#函数声明" aria-hidden="true" class="header-anchor">#</a> 函数声明</h4><p>函数声明不是在执行到达时处理的，而是在创建词汇环境时处理的。对于全局词法环境来说，就是脚本开始的时候。</p><p><img src="https://javascript.info/article/closure/lexical-environment-global-3.png" alt="img"></p><h4 id="内部和外部词法环境"><a href="#内部和外部词法环境" aria-hidden="true" class="header-anchor">#</a> 内部和外部词法环境</h4><p>当函数运行时，会自动创建一个新的函数词法环境。所有函数都遵循这一规则。这个词法环境是用来存储局部变量和调用的参数的。</p><p>下图是当函数执行到 <code>say(&quot;John&quot;)</code> 里面的时候：</p><p><img src="https://javascript.info/article/closure/lexical-environment-simple.png" alt="img"></p><p><strong>当代码试图访问一个变量时 —— 它首先会在内部词法环境中进行搜索，然后是外部环境，然后是更外部的环境，直到（词法环境）链的末尾。</strong></p><p>在严格模式下，变量未定义会导致错误。在非严格模式下，为了向后兼容，给未定义的变量赋值会创建一个全局变量。</p><p><img src="https://javascript.info/article/closure/lexical-environment-simple-lookup.png" alt="img"></p><p>函数是在执行到它的时候访问外部变量，也就是使用的是最新的值。</p><p>每执行一个函数就会创建一个词法环境。</p><p>如果一个函数被多次调用，那么每次调用都有自己的词法环境，其中有特定于该运行的局部变量和参数。</p><h4 id="嵌套函数"><a href="#嵌套函数" aria-hidden="true" class="header-anchor">#</a> 嵌套函数</h4><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> count<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">// has access to the outer counter</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token function">makeCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">counter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>

</code></pre></div><p><img src="https://javascript.info/article/closure/lexical-search-order@2x.png" alt="img"></p><ol><li>The locals of the nested function…</li><li>The variables of the outer function…</li><li>And so on until it reaches global variables.</li></ol><p>In this example <code>count</code> is found on step <code>2</code>. When an outer variable is modified, it’s changed where it’s found. So <code>count++</code> finds the outer variable and increases it in the Lexical Environment where it belongs. Like if we had <code>let count = 1</code>.</p><p>they automatically remember where they were created using a hidden <code>[[Environment]]</code>property, and all of them can access outer variables.</p><p>When on an interview, a frontend developer gets a question about “what’s a closure?”, a valid answer would be a definition of the closure and an explanation that all functions in JavaScript are closures, and maybe few more words about technical details: the <code>[[Environment]]</code> property and how Lexical Environments work.</p><h4 id="code-blocks-and-loops-iife"><a href="#code-blocks-and-loops-iife" aria-hidden="true" class="header-anchor">#</a> Code blocks and loops, IIFE</h4><p>上面讲的都是函数，词法环境也存在于块 <code>{...}</code>。</p><h5 id="if"><a href="#if" aria-hidden="true" class="header-anchor">#</a> if</h5><p><img src="https://javascript.info/article/closure/lexenv-if@2x.png" alt="img"></p><p>&quot;if-only&quot; 词法环境</p><h5 id="for-thile"><a href="#for-thile" aria-hidden="true" class="header-anchor">#</a> For, thile</h5><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Each loop has its own Lexical Environment</span>
  <span class="token comment">// {i: value}</span>
<span class="token punctuation">}</span>

<span class="token function">alert</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Error, no such variable</span>
</code></pre></div><h5 id="code-blocks"><a href="#code-blocks" aria-hidden="true" class="header-anchor">#</a> Code blocks</h5><div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token comment">// do some job with local variables that should not be seen outside</span>

  <span class="token keyword">let</span> message <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>

  <span class="token function">alert</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello</span>
<span class="token punctuation">}</span>

<span class="token function">alert</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Error: message is not defined</span>
</code></pre></div><h5 id="iife"><a href="#iife" aria-hidden="true" class="header-anchor">#</a> IIFE</h5><p>immediately-invoked function expressions 立即调用函数表达式</p><p>函数本身不能同时声明和调用，需要包裹一个圆括号，说明函数是在另一个表达式上下文中创建的，也就是说是一个函数表达式，这样就不需要名字也可以被直接调用。</p><h3 id="任务"><a href="#任务" aria-hidden="true" class="header-anchor">#</a> 任务</h3><h4 id="filter-through-function"><a href="#filter-through-function" aria-hidden="true" class="header-anchor">#</a> Filter through function</h4><p>数组中有个内建的 <code>arr.filter(f)</code> 方法。它通过函数 <code>f</code> 过滤元素。如果元素返回 <code>true</code> 的，那么该元素会被返回到结果数组中。</p><p>制造一系列『马上能用』的过滤器：</p><ul><li><code>inBetween(a, b)</code> —— 在 <code>a</code> 和 <code>b</code> 之间或与它们相等（包括）。</li><li><code>inArray([...])</code> —— 包含在给定的数组中。</li></ul><p>用法如下所示：</p><ul><li><code>arr.filter(inBetween(3,6))</code> —— 只挑选 3 和 6 之间的值。</li><li><code>arr.filter(inArray([1,2,3]))</code> —— 只挑选与 <code>[1,2,3]</code> 其中成员匹配的元素。</li></ul><p>举个例子：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/* .. inBetween 和 inArray 的代码 */</span>
<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">inBetween</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3,4,5,6</span>
<span class="token function">alert</span><span class="token punctuation">(</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">inArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2</span>
</code></pre></div><p>答：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">inBetween</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> x <span class="token operator">&gt;=</span> a <span class="token operator">&amp;&amp;</span> x <span class="token operator">&lt;=</span> b<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">inBetween</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3,4,5,6</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">inArray</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> arr<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span> arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token function">inArray</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2</span>
</code></pre></div><h4 id="sort-by-field"><a href="#sort-by-field" aria-hidden="true" class="header-anchor">#</a> Sort by field</h4><p>我们有一组要排序的对象：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> users <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span> surname<span class="token punctuation">:</span> <span class="token string">&quot;Johnson&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Pete&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">18</span><span class="token punctuation">,</span> surname<span class="token punctuation">:</span> <span class="token string">&quot;Peterson&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">&quot;Ann&quot;</span><span class="token punctuation">,</span> age<span class="token punctuation">:</span> <span class="token number">19</span><span class="token punctuation">,</span> surname<span class="token punctuation">:</span> <span class="token string">&quot;Hathaway&quot;</span> <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>通常的做法应该是这样的：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 通过 name (Ann, John, Pete)</span>
users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>name <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 通过 age (Pete, Ann, John)</span>
users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">.</span>age <span class="token operator">&gt;</span> b<span class="token punctuation">.</span>age <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以让它更加简洁吗，比如这样？</p><div class="language-js extra-class"><pre class="language-js"><code>users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token function">byField</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
users<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token function">byField</span><span class="token punctuation">(</span><span class="token string">'age'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>那么，我们只需要写 <code>byField(fieldName)</code>，而不是写一个函数。</p><p>编写可用于此目的的函数 <code>byField</code>。</p><p>答：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">byField</span><span class="token punctuation">(</span>field<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">&gt;</span> b<span class="token punctuation">[</span>field<span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-4-the-old-var"><a href="#_6-4-the-old-var" aria-hidden="true" class="header-anchor">#</a> 6.4 The old &quot;var&quot;</h2><p><code>var</code> 会忽略块级作用域</p><p>变量声明在函数开始时处理</p><h2 id="_6-5-global-object-全局对象"><a href="#_6-5-global-object-全局对象" aria-hidden="true" class="header-anchor">#</a> 6.5 Global object-全局对象</h2><p>全局对象在浏览器下是 <code>window</code></p><p>在 Node.Js 下是 <code>global</code></p><p>var声明的是全局对象的变量，但是let/const声明的不是</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// John</span>

<span class="token function">alert</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// undefined, don't have let</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span> <span class="token keyword">in</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>

<span class="token keyword">var</span> phrase <span class="token operator">=</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span> window<span class="token punctuation">.</span>phrase <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello (global var)</span>
</code></pre></div><p>注意：</p><p>在 ES-2015之前，全局变量是用来当做全局环境记录的，在这之后，是由全局词法环境来进行环境记录，而全局对象只是提供了一些全局变量而已。实际上来说， let/const 是全局环境记录的变量，而不属于全局对象。</p><h2 id="_6-6-function-object-nfe"><a href="#_6-6-function-object-nfe" aria-hidden="true" class="header-anchor">#</a> 6.6 Function object, NFE</h2><p>函数对象有 name 属性</p><p>上下文命名：contextual name，如果函数没有提供名称，就去上下文的赋值中寻找。</p><p>length 属性，可以返回函数参数的个数</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f1</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">f2</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">many</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token operator">...</span>more<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token function">alert</span><span class="token punctuation">(</span>f1<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
<span class="token function">alert</span><span class="token punctuation">(</span>f2<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
<span class="token function">alert</span><span class="token punctuation">(</span>many<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 2</span>
</code></pre></div><p>剩余参数不作数。</p><p>Named Function Expression：NFE 命名函数表达式</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token function-variable function">sayHi</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>who<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>使用场景：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> <span class="token function-variable function">sayHi</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span>who<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>who<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>who<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">func</span><span class="token punctuation">(</span><span class="token string">&quot;Guest&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Now all fine</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> welcome <span class="token operator">=</span> sayHi<span class="token punctuation">;</span>
sayHi <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, Guest (nested call works)</span>
</code></pre></div><p>这种命名只能用在函数表达式上，不能用在函数声明上面。</p><p>它们创建一个「主」函数，然后给它附加很多其它「helper」函数。比如，<a href="https://jquery.com/" target="_blank" rel="noopener noreferrer">jquery<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 库创建了一个名为 <code>$</code> 的函数。<a href="https://lodash.com/" target="_blank" rel="noopener noreferrer">lodash<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 库创建一个 <code>_</code> 函数。然后添加了 <code>_.add</code>、<code>_.keyBy</code> 以及其它属性。</p><h3 id="任务-2"><a href="#任务-2" aria-hidden="true" class="header-anchor">#</a> 任务</h3><p>Write function <code>sum</code> that would work like this:</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 1 + 2</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// 1 + 2 + 3</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">6</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span>
<span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">15</span>
</code></pre></div><ol><li>sum返回的必须是函数</li><li>函数必须记住当前的总数</li><li>返回的是函数，函数是对象，但是要 == 于数字，所以要转换成原始值</li></ol><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  name<span class="token punctuation">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
  money<span class="token punctuation">:</span> <span class="token number">1000</span><span class="token punctuation">,</span>

  <span class="token comment">// for hint=&quot;string&quot;</span>
  <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token string">`{name: &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;}`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// for hint=&quot;number&quot; or &quot;default&quot;</span>
  <span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>money<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// toString -&gt; {name: &quot;John&quot;}</span>
<span class="token function">alert</span><span class="token punctuation">(</span><span class="token operator">+</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// valueOf -&gt; 1000</span>
<span class="token function">alert</span><span class="token punctuation">(</span>user <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// valueOf -&gt; 1500</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> currentSum <span class="token operator">=</span> a<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentSum <span class="token operator">+=</span> b<span class="token punctuation">;</span>
    <span class="token keyword">return</span> f<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  f<span class="token punctuation">.</span><span class="token function-variable function">toString</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> currentSum<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 15</span>
</code></pre></div><h2 id="_6-7-the-new-function-syntax"><a href="#_6-7-the-new-function-syntax" aria-hidden="true" class="header-anchor">#</a> 6.7 The &quot;new Function&quot; syntax</h2><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>arg1<span class="token punctuation">[</span><span class="token punctuation">,</span> arg2<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">...</span>argN<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">]</span> functionBody<span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'return a + b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><p>所有的参数都是字符串</p><h3 id="闭包"><a href="#闭包" aria-hidden="true" class="header-anchor">#</a> 闭包</h3><p>通常，函数会使用一个特殊的属性 <code>[[Environment]]</code> 来记录函数创建时的环境，它具体指向了函数创建时的词法环境。</p><p>但是如果我们使用 <code>new Function</code> 创建函数，函数的 <code>[[Environment]]</code> 并不指向当前的词法环境，而是指向全局环境。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> func <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Function</span><span class="token punctuation">(</span><span class="token string">'alert(value)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> func<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// error: value is not defined</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> value <span class="token operator">=</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> <span class="token function-variable function">func</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">alert</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> func<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getFunc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;test&quot;, from the Lexical Environment of getFunc</span>
</code></pre></div><h2 id="_6-8-scheduling-settimeout-and-setinterval"><a href="#_6-8-scheduling-settimeout-and-setinterval" aria-hidden="true" class="header-anchor">#</a> 6.8 Scheduling: setTimeout and setInterval</h2><p>scheduling a call</p><h3 id="settimeout"><a href="#settimeout" aria-hidden="true" class="header-anchor">#</a> setTimeout</h3><p>语法：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> timerId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>func<span class="token operator">|</span>code<span class="token punctuation">,</span> delay<span class="token punctuation">[</span><span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">sayHi</span><span class="token punctuation">(</span>phrase<span class="token punctuation">,</span> who<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> phrase <span class="token operator">+</span> <span class="token string">', '</span> <span class="token operator">+</span> who <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span>sayHi<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">&quot;Hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, John</span>
</code></pre></div><h4 id="cleartimeout"><a href="#cleartimeout" aria-hidden="true" class="header-anchor">#</a> clearTimeout</h4><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> timerId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;never happens&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// timer identifier</span>

<span class="token function">clearTimeout</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">alert</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// same identifier (doesn't become null after canceling)</span>
</code></pre></div><h3 id="setinterval"><a href="#setinterval" aria-hidden="true" class="header-anchor">#</a> setInterval</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> timerId <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span>func<span class="token operator">|</span>code<span class="token punctuation">,</span> delay<span class="token punctuation">[</span><span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token operator">...</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// repeat with the interval of 2 seconds</span>
<span class="token keyword">let</span> timerId <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'tick'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// after 5 seconds stop</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span>timerId<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'stop'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="recursive-settimeout"><a href="#recursive-settimeout" aria-hidden="true" class="header-anchor">#</a><a href="https://javascript.info/settimeout-setinterval#recursive-settimeout" target="_blank" rel="noopener noreferrer">Recursive setTimeout<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/** instead of:
let timerId = setInterval(() =&gt; alert('tick'), 2000);
*/</span>

<span class="token keyword">let</span> timerId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'tick'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  timerId <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>tick<span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (*)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>pseudocode： 伪代码</p><h4 id="垃圾回收："><a href="#垃圾回收：" aria-hidden="true" class="header-anchor">#</a> 垃圾回收：</h4><p>当一个函数传入 <code>setInterval/setTimeout</code> 时，会创建一个内部引用，并保存在调度器中。这样会防止函数被垃圾回收，即使是没有别的引用到它。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// the function stays in memory until the scheduler calls it</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于 <code>setInterval</code>，直到调用 <code>clearInterval</code> 才会被清除掉。</p><p>这会有副作用，函数引用了外部词法环境，那么外部变量也就会活着。它们可能会耗费比函数本身更多的内存。所以即使是很小的函数，如果不需要了，也最好是要清空。</p><h3 id="settimeout-…-0"><a href="#settimeout-…-0" aria-hidden="true" class="header-anchor">#</a> setTimeout(…,0)</h3><p>有一种特殊的用法，可以看做是异步：<em>asynchronously</em></p><p><code>setTimeout(func, 0)</code></p><p>当前代码执行完后立即执行</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="splitting-cpu-hungry-tasks"><a href="#splitting-cpu-hungry-tasks" aria-hidden="true" class="header-anchor">#</a> Splitting CPU-hungry tasks</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// do a heavy job</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1e9</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Done in &quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'ms'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>给浏览器渲染提供喘息的机会</p><div class="language-markup extra-class"><pre class="language-markup"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>progress<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// do a piece of the heavy job (*)</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
      progress<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">1e3</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">1e9</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span>count<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>

  <span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_6-9-decorators-and-forwarding-call-apply"><a href="#_6-9-decorators-and-forwarding-call-apply" aria-hidden="true" class="header-anchor">#</a> 6.9 Decorators and forwarding, call/apply</h2><h3 id="缓存装饰器"><a href="#缓存装饰器" aria-hidden="true" class="header-anchor">#</a> 缓存装饰器</h3><p>如果一个函数负载比较重，但是结果是稳定的，对于相同的输入，总是返回相同的结果的话，就可以缓存这些结果。创建一个装饰器。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">slow</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 这里可能会有重负载的CPU密集型工作</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Called with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>x<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">cachingDecorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 如果结果在 map 里</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回它</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">func</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 否则就调用函数</span>

    cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 然后把结果缓存起来</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

slow <span class="token operator">=</span> <span class="token function">cachingDecorator</span><span class="token punctuation">(</span>slow<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// slow(1) 被缓存起来了</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token string">&quot;Again: &quot;</span> <span class="token operator">+</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 一样的</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// slow(2) 被缓存起来了</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token string">&quot;Again: &quot;</span> <span class="token operator">+</span> <span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 也是一样</span>
</code></pre></div><p>在上面的代码中，<code>cachingDecorator</code> 是一个<strong>装饰器</strong>：一个特殊的函数，它接受另一个函数并改变它的行为。</p><p>把缓存写在外面的装饰器的好处：</p><ul><li><code>cachingDecorator</code> 可以被重用，应用于其它函数。</li><li>缓存的逻辑是分开的，没有增加 <code>slow</code> 函数本身的复杂度。</li><li>如果需要，可以绑定多个装饰器</li></ul><h3 id="using-“func-call”-for-the-context"><a href="#using-“func-call”-for-the-context" aria-hidden="true" class="header-anchor">#</a> Using “func.call” for the context</h3><p>如果是对象中的方法，就需要绑定上下文了。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code>func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> arg1<span class="token punctuation">,</span> arg2<span class="token punctuation">,</span> <span class="token operator">...</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> worker <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token function">slow</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">&quot;Called with &quot;</span> <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> x <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">someMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (*)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">cachingDecorator</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// &quot;this&quot; is passed correctly now</span>
    cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

worker<span class="token punctuation">.</span>slow <span class="token operator">=</span> <span class="token function">cachingDecorator</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span>slow<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// now make it caching</span>

<span class="token function">alert</span><span class="token punctuation">(</span> worker<span class="token punctuation">.</span><span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// works</span>
<span class="token function">alert</span><span class="token punctuation">(</span> worker<span class="token punctuation">.</span><span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// works, doesn't call the original (cached)</span>
</code></pre></div><p>this 是怎么传递的：</p><ol><li>在装饰器过后， <code>worker.slow</code> 现在是 wrapper <code>function (x) { ... }</code>。</li><li>当  <code>worker.slow(2)</code> 执行的时候，wrapper 接受 2 作为参数， 然后  <code>this=worker</code> （点前面的对象）</li><li>在 wrapper 内部，如果没有被缓存过，则 <code>func.call(this, x)</code> 将当前的 <code>this</code>(<code>=worker</code>) 和当前的参数 (<code>=2</code>) 传递给原始函数。</li></ol><h3 id="going-multi-argument-with-“func-apply”"><a href="#going-multi-argument-with-“func-apply”" aria-hidden="true" class="header-anchor">#</a> Going multi-argument with “func.apply”</h3><p>如果是多参数怎么办呢，首先需要解决的如何缓存多参数/双参数</p><ol><li>实现一个新的类似map的数据结构（或使用第三方库），更加通用，能够允许多键。</li><li>使用嵌套 map，如 <code>cache.get(min).get(max)</code>。</li><li>把两个值合成一个。在这个例子中可以直接使用字符串  <code>&quot;min,max&quot;</code> 作为 <code>Map</code> 的键。为了灵活性，我们可以允许为装饰器提供<strong>散列函数</strong>，它知道如何从多个中创建一个值。</li></ol><p>这里使用第三种方法。</p><p>下一个问题是如何将多参数传递给<code>func</code>。</p><div class="language-javascript extra-class"><pre class="language-javascript"><code>func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span>
</code></pre></div><p>使用展开运算符的话，call 和 apply 就都可以实现了：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// pass an array as list with spread operator</span>
func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// is same as using apply</span>
</code></pre></div><p>但二者还是有区别的：</p><ul><li>展开运算符 <code>…</code> 允许传递可迭代的 <code>args</code> 给 <code>call</code>。</li><li><code>apply</code> 只能接受类数组 <code>args</code></li></ul><p><code>apply</code> 最重要的用途之一是将调用传递给另一个函数，如下所示：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">wrapper</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> anotherFunction<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> worker <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">slow</span><span class="token punctuation">(</span>min<span class="token punctuation">,</span> max<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`Called with </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>min<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">,</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>max<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> min <span class="token operator">+</span> max<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">cachingDecorator</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> key <span class="token operator">=</span> <span class="token function">hash</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (*)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> result <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (**)</span>

    cache<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">','</span> <span class="token operator">+</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

worker<span class="token punctuation">.</span>slow <span class="token operator">=</span> <span class="token function">cachingDecorator</span><span class="token punctuation">(</span>worker<span class="token punctuation">.</span>slow<span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span> worker<span class="token punctuation">.</span><span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// works</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token string">&quot;Again &quot;</span> <span class="token operator">+</span> worker<span class="token punctuation">.</span><span class="token function">slow</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// same (cached)</span>
</code></pre></div><h3 id="borrowing-a-method"><a href="#borrowing-a-method" aria-hidden="true" class="header-anchor">#</a> Borrowing a method</h3><p>如果是多参数怎么办呢，传进去的 arguments 是伪数组，不能直接调用 join，所以需要借用一下</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span>join<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1,2</span>
<span class="token punctuation">}</span>

<span class="token function">hash</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The trick is called <em>method borrowing</em>.</p><p>需要注意的一点是如果原函数有自己的属性，那么装饰器则不会提供。</p><h3 id="任务-3"><a href="#任务-3" aria-hidden="true" class="header-anchor">#</a> 任务</h3><h4 id="delaying-decorator"><a href="#delaying-decorator" aria-hidden="true" class="header-anchor">#</a> Delaying decorator</h4><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> f<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><p>如果不用箭头函数，要事先提取出参数和 this：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment">// added variables to pass this and arguments from the wrapper inside setTimeout</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> savedThis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      f<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>savedThis<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><h3 id="debounce-decorator"><a href="#debounce-decorator" aria-hidden="true" class="header-anchor">#</a> Debounce decorator</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">debounce</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> isCooldown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isCooldown<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    f<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span>

    isCooldown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> isCooldown <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div><ul><li><code>isCooldown = false</code> – ready to run.</li><li><code>isCooldown = true</code> – waiting for the timeout.</li></ul><h3 id="throttle-decorator"><a href="#throttle-decorator" aria-hidden="true" class="header-anchor">#</a> Throttle decorator</h3><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">throttle</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> ms<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">let</span> isThrottled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    savedArgs<span class="token punctuation">,</span>
    savedThis<span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">wrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isThrottled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// (2)</span>
      savedArgs <span class="token operator">=</span> arguments<span class="token punctuation">;</span>
      savedThis <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// (1)</span>

    isThrottled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isThrottled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// (3)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>savedArgs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        wrapper<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>savedThis<span class="token punctuation">,</span> savedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        savedArgs <span class="token operator">=</span> savedThis <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> wrapper<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_6-10-function-binding"><a href="#_6-10-function-binding" aria-hidden="true" class="header-anchor">#</a> 6.10 Function binding</h2><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// more complex syntax will be little later</span>
<span class="token keyword">let</span> boundFunc <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  firstName<span class="token punctuation">:</span> <span class="token string">&quot;John&quot;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> funcUser <span class="token operator">=</span> func<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">funcUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// John</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  firstName<span class="token punctuation">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
  <span class="token function">say</span><span class="token punctuation">(</span>phrase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phrase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> say <span class="token operator">=</span> user<span class="token punctuation">.</span>say<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello, John (&quot;Hello&quot; argument is passed to say)</span>
<span class="token function">say</span><span class="token punctuation">(</span><span class="token string">&quot;Bye&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Bye, John (&quot;Bye&quot; is passed to say)</span>
</code></pre></div><p>bindAll：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">in</span> user<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> user<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    user<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> user<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不能被重复绑定：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">alert</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

f <span class="token operator">=</span> f<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span> <span class="token string">&quot;Pete&quot;</span><span class="token punctuation">}</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// John</span>
</code></pre></div><h2 id="_6-11-currying-and-partials"><a href="#_6-11-currying-and-partials" aria-hidden="true" class="header-anchor">#</a> 6.11 Currying and partials</h2><p>bind的完整语法：</p><div class="language-j&#39;s extra-class"><pre class="language-text"><code>let bound = func.bind(context, arg1, arg2, ...);
</code></pre></div><p>partial function application - 偏函数应用：创建一个新的函数，覆盖一些已知的参数</p><p>如果不想绑定上下文，只修改参数的话：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">partial</span><span class="token punctuation">(</span>func<span class="token punctuation">,</span> <span class="token operator">...</span>argsBound<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// (*)</span>
    <span class="token keyword">return</span> func<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>argsBound<span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Usage:</span>
<span class="token keyword">let</span> user <span class="token operator">=</span> <span class="token punctuation">{</span>
  firstName<span class="token punctuation">:</span> <span class="token string">&quot;John&quot;</span><span class="token punctuation">,</span>
  <span class="token function">say</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> phrase<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`[</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>time<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">] </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>firstName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>phrase<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// add a partial method that says something now by fixing the first argument</span>
user<span class="token punctuation">.</span>sayNow <span class="token operator">=</span> <span class="token function">partial</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>say<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHours</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

user<span class="token punctuation">.</span><span class="token function">sayNow</span><span class="token punctuation">(</span><span class="token string">&quot;Hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Something like:</span>
<span class="token comment">// [10:00] John: Hello!</span>
</code></pre></div><p>Also there’s a ready <a href="https://lodash.com/docs#partial" target="_blank" rel="noopener noreferrer">_.partial<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> implementation from lodash library.</p><p>lodash的例子：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">greet</span><span class="token punctuation">(</span>greeting<span class="token punctuation">,</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> greeting <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> name<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">var</span> sayHelloTo <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">partial</span><span class="token punctuation">(</span>greet<span class="token punctuation">,</span> <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">sayHelloTo</span><span class="token punctuation">(</span><span class="token string">'fred'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; 'hello fred'</span>
 
<span class="token comment">// Partially applied with placeholders.</span>
<span class="token keyword">var</span> greetFred <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">partial</span><span class="token punctuation">(</span>greet<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token string">'fred'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">greetFred</span><span class="token punctuation">(</span><span class="token string">'hi'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; 'hi fred'</span>
</code></pre></div><h3 id="currying"><a href="#currying" aria-hidden="true" class="header-anchor">#</a> Currying</h3><p><a href="https://en.wikipedia.org/wiki/Currying" target="_blank" rel="noopener noreferrer">Currying<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是一项将一个调用形式为 <code>f(a, b, c)</code> 的函数转化为调用形式为 <code>f(a)(b)(c)</code> 的技术</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">curry</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// usage</span>
<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> carriedSum <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">carriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>
</code></pre></div><ul><li><code>curry(func)</code> 的结果是 wrapper <code>function(a)</code>。</li><li>当像  <code>sum(1)</code> 一样被调用的时候，参数被保存在词法环境中，然后返回一个新的 wrapper  <code>function(b)</code>。</li><li>然后 <code>sum(1)(2)</code> 最终调用  <code>function(b)</code> ，以2为参数，传递给原始的多参数 <code>sum</code>。</li></ul><p>lodash 的 <a href="https://lodash.com/docs#curry" target="_blank" rel="noopener noreferrer">_.curry<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>会更复杂一些：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">curry</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// if args.length == f.length (as many arguments as f has),</span>
    <span class="token comment">//   then pass the call to f</span>
    <span class="token comment">// otherwise return a partial function that fixes args as first arguments</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>lodash里的例子：</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> <span class="token function-variable function">abc</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">var</span> curried <span class="token operator">=</span> _<span class="token punctuation">.</span><span class="token function">curry</span><span class="token punctuation">(</span>abc<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token function">curried</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; [1, 2, 3]</span>
 
<span class="token function">curried</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; [1, 2, 3]</span>
 
<span class="token function">curried</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; [1, 2, 3]</span>
 
<span class="token comment">// Curried with placeholders.</span>
<span class="token function">curried</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// =&gt; [1, 2, 3]</span>
</code></pre></div><p>高级柯里化实现：</p><div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">curry</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">curried</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>length <span class="token operator">&gt;=</span> func<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> func<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token operator">...</span>args2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> curried<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>args2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sum</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token operator">+</span> c<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> curriedSum <span class="token operator">=</span> <span class="token function">curry</span><span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// still callable normally</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>

<span class="token comment">// get the partial with curried(1) and call it with 2 other arguments</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>

<span class="token comment">// full curried form</span>
<span class="token function">alert</span><span class="token punctuation">(</span> <span class="token function">curriedSum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 6</span>
</code></pre></div><h2 id="_6-12-arrow-functions-revisited"><a href="#_6-12-arrow-functions-revisited" aria-hidden="true" class="header-anchor">#</a> 6.12 Arrow functions revisited</h2><p>There’s a subtle difference between an arrow function <code>=&gt;</code> and a regular function called with <code>.bind(this)</code>:</p><ul><li><code>.bind(this)</code> creates a “bound version” of the function.</li><li>The arrow <code>=&gt;</code> doesn’t create any binding. The function simply doesn’t have <code>this</code>. The lookup of <code>this</code> is made exactly the same way as a regular variable search: in the outer lexical environment.</li></ul><p>Arrow functions:</p><ul><li>Do not have <code>this</code>.</li><li>Do not have <code>arguments</code>.</li><li>Can’t be called with <code>new</code>.</li><li>(They also don’t have <code>super</code>, but we didn’t study it. Will be in the chapter <a href="https://javascript.info/class-inheritance" target="_blank" rel="noopener noreferrer">Class inheritance, super<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>).</li></ul></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/notebook/tutorial/modern-tutorial-part1.html" class="prev">
          PART 1
        </a></span><span class="next"><a href="/notebook/tutorial/modern-tutorial-part2.html">
          PART 2
        </a> →
      </span></p></div></div></div></div>
    <script src="/notebook/assets/js/4.91ed248e.js" defer></script><script src="/notebook/assets/js/app.e422ee42.js" defer></script>
  </body>
</html>
